<div *ngIf="!experimento" class="flex justify-content-center align-items-center h-full">
    <p-progressSpinner></p-progressSpinner>
</div>

<div *ngIf="experimento" class="grid p-fluid">
    <p-toast></p-toast>
    
    <div class="col-12 mb-3">
    <p-card header="Detalhes do Experimento">
        <div class="formgrid grid">
            
            <div class="field col-12 md:col-6 mb-3">
                <label class="font-bold block mb-1">Nome do Experimento</label>
                <p class="text-lg m-0">{{ experimento.nome }}</p>
            </div>

            <div class="field col-12 md:col-6 mb-3">
                <label class="font-bold block mb-1">Pesquisador Responsável</label>
                <p class="text-lg m-0">{{ experimento.pesquisador?.nome }}</p>
            </div>

            <div class="field col-12 md:col-6 mb-3">
                <label class="font-bold block mb-1">Data de Início</label>
                <p class="m-0">{{ experimento.dataInicio | date:'dd/MM/yyyy' }}</p>
            </div>

            <div class="field col-12 md:col-6 mb-3">
                <label class="font-bold block mb-1">Data de Fim</label>
                <p class="m-0">{{ experimento.dataFim | date:'dd/MM/yyyy' }}</p>
            </div>

            <div class="field col-12 md:col-6 mb-3">
                <label class="font-bold block mb-1">Status</label>
                <p class="m-0">{{ experimento.statusExperimento | titlecase }}</p>
            </div>

            <div class="field col-12">
                <label class="font-bold block mb-1">Descrição</label>
                <div class="mt-1 p-2 border-1 surface-border border-round" style="white-space: pre-wrap;">
                    {{ experimento.descricao }}
                </div>
            </div>

        </div>
    </p-card>
</div>

    <div class="col-12 md:col-6 mb-3">
        <p-card>
            <ng-template pTemplate="title">
                Participantes Inscritos ({{ experimento.participantes?.length || 0 }})
            </ng-template>
            <p-table [value]="experimento.participantes" [tableStyle]="{'min-width': '30rem'}">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Ação</th> </tr>
                </ng-template>
                <ng-template pTemplate="body" let-participante>
                    <tr>
                        <td>{{ participante.nomeCompleto }}</td>
                        <td>{{ participante.email }}</td>
                        <td>
                            <p-button icon="pi pi-play-circle"
                                      pTooltip="Iniciar coleta de dados para este participante" tooltipPosition="top"
                                      (click)="iniciarColeta(participante.id)"
                                      [disabled]="experimento.statusExperimento !== 'EM_ANDAMENTO'"
                                      styleClass="p-button-sm p-button-success"></p-button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr><td colspan="3">Nenhum participante inscrito neste experimento.</td></tr>
                </ng-template>
            </p-table>
        </p-card>
    </div>

    <div class="col-12 md:col-6 mb-3">
        <p-card header="Adicionar Participantes ao Experimento">
            <p-table [value]="todosParticipantes" [tableStyle]="{'min-width': '30rem'}" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Nome</th>
                        <th>Ação</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-participante>
                    <tr>
                        <td>{{ participante.nomeCompleto }}</td>
                        <td>
                            <p-button icon="pi pi-plus"
                                      label="Adicionar"
                                      (click)="adicionarParticipante(participante.id)"
                                      styleClass="p-button-sm"></p-button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr><td colspan="2">Todos os participantes já estão neste experimento.</td></tr>
                </ng-template>
            </p-table>
        </p-card>
    </div>
</div>

<p-dialog header="Código da Sessão de Coleta" [(visible)]="exibirDialogCodigo" [modal]="true" [style]="{width: '350px'}">
    <div class="text-center" *ngIf="codigoSessao">
        <p>Informe o código abaixo para o participante inserir no aplicativo móvel.</p>
        <div class="text-3xl font-bold my-4 p-3 border-2 border-dashed border-primary border-round">
            {{ codigoSessao }}
        </div>
        <p>Este código expira em 5 minutos.</p>
    </div>
    <ng-template pTemplate="footer">
        <p-button icon="pi pi-check" (click)="exibirDialogCodigo = false" label="Ok" styleClass="p-button-text"></p-button>
    </ng-template>
</p-dialog>